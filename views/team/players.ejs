<div class="container">
  <h1>Players</h1>
  <div class="pb-2 w-25">
    <input class="form-control" id="myInput" type="text" placeholder="Search..">
  </div>
  
  <div class="row">
    <!-------- Filters -------->
    <div class="col">
      <div class="pb-3">
        <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#orderBy">
          Order by
        </button>
      </div>
      <div id="orderBy" class="collapse show pb-3">
        <!-- Order by buttons -->
      </div>
      <div class="pb-3">
        <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#skillLevel">
          Skill Level
        </button>
      </div>
      <div id="skillLevel" class="collapse show pb-3">
        <!-- Filter by skill buttons -->
      </div>
      <button type="button" class="btn btn-primary" id="clearFilters">Cear all filters</button>
    </div>

    <!-------- Player Data -------->
    <div class="col-10">
      <div class="row row-cols-1 row-cols-md-3" id="myPlayers">
        <% players.forEach( item => { %>
          <div class="col mb-4 playerList">
            <div class="card">
                <img
                src="<%= item.picture %>"
                class="card-img-top"
                alt="player profile"
                width="380"
                height="200"
                />
                <div class="card-body">
                  <h5 class="card-title"><%= item.fname %> <%= item.lname %></h5>
                  <div class="card-text">
                      <p class="sport">Sport: <%= item.sport %></p>
                      <p class="skill">Skill: <%= item.skill %></p>
                  </div>
                  <a class="btn btn-primary" href= <%= "/players/" + item.id %>>Click here for more info</a>
                </div>
            </div>
          </div>
        <%})%>
      </div>
    </div>

  </div>
</div>

<!-- Event Listeners -->
<script>
  // -------- Order by Buttons -------- //
  let orderOptions = [
    {
      'id' : 'alphaAZ',
      'input' : 'Player name (A-Z)'
    },
    {
      'id' : 'alphaZA',
      'input' : 'Player name (Z-A)'
    }
  ]
  orderOptions.forEach(function (item) {
    $('<div/>', {
      'class' : 'form-check'
    }
      ).appendTo('#orderBy').append(
        $('<input>', {
          'class' : 'form-check-input',
          'type' : 'radio',
          'name' : 'myOrder',
          'id' : `${item.id}`
        }),
        $('<label/>', {
          'class' : 'form-check-label',
          'for' : 'myOrder',
          'text' : `${item.input}`
        })
      );
  })

  // -------- Filter by skill buttons -------- //
  let skillOptions = [
    {
      'id' : 'beginner',
      'input' : 'Beginner'
    },
    {
      'id' : 'intermediate',
      'input' : 'Intermediate'
    },
    {
      'id' : 'advanced',
      'input' : 'Advanced'
    }
  ]
  skillOptions.forEach(function (item) {
    $('<div/>', {
      'class' : 'form-check'
    }
      ).appendTo('#skillLevel').append(
        $('<input>', {
          'class' : 'form-check-input',
          'type' : 'checkbox',
          'name' : 'playerSkill',
          'id' : `${item.id}`,
          'value': `${item.id}`
        }),
        $('<label/>', {
          'class' : 'form-check-label',
          'for' : 'defaultCheck1',
          'text' : `${item.input}`
        })
      );
  })

  $(document).ready(function(){
    // -------- Search Function -------- //
    $("#myInput").on("keyup", function() {
      var value = $(this).val().toLowerCase();
      $("#myPlayers .playerList").filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
      });
    });

    // -------- Order by alphabet -------- //
    let mylist = $('#myPlayers');
    let listitems = mylist.children('.playerList').get();

    $("#alphaAZ").on("click", applyOrderby);
    $("#alphaZA").on("click", applyOrderby);

    function applyOrderby(e) {
      listitems.sort(function(a, b) {
        return $(a).children('div').children('div').children('.card-title').text().toUpperCase().localeCompare($(b).children('div').children('div').children('.card-title').text().toUpperCase());
      })
      $.each(listitems, function(idx, itm) {
        for (let i = itm.classList.length - 1; i >= 0; i--) {
          const className = itm.classList[i];
          if (className.startsWith('order')) {
            itm.classList.remove(className);
          }
        }
        if (e.target.id === 'alphaAZ') {
          $(itm).addClass(`order-${(idx+1)}`);
        } else {
          $(itm).addClass(`order-${(listitems.length - idx)}`)
        }
      });
    }
    
    // -------- Filter by skill -------- //
    var allCheckboxes = document.querySelectorAll('input[type=checkbox]');
    var allPlayers = Array.from(document.querySelectorAll('.playerList'));
    var checked = {};

    getChecked('playerSkill');
    // getChecked('injured');

    Array.prototype.forEach.call(allCheckboxes, function (el) {
      el.addEventListener('change', toggleCheckbox);
    });

    function toggleCheckbox(e) {
      getChecked(e.target.name);
      setVisibility();
    }

    function getChecked(name) {
      checked[name] = Array.from(document.querySelectorAll('input[name=' + name + ']:checked')).map(function (el) {
        return el.value;
      });
    }

    function setVisibility() {
      allPlayers.map(function (el) {
        var playerSkill = checked.playerSkill.length ? _.intersection([($(el).children('div').children('div').children('.card-text').children('.skill').text().toLowerCase().substr(7))], checked.playerSkill).length : true;
        // var injured = checked.injured.length ? _.intersection(Array.from(el.classList), checked.injured).length : true;
        if (playerSkill) {
        // if (startingReserves && injured && position && nbaTeam && conference) {
          // el.style.display = 'block';
          $(el).toggle(true);
        } else {
          // el.style.display = 'none';
          $(el).toggle(false);
        }
      });
    }

    // -------- Clear Filters -------- //
    $("#clearFilters").on("click", function() {
      $('input[type=checkbox]').prop('checked',false);
      $('input[type=radio]').prop('checked',false);
      $('.playerList').show();

      var resetList = $('#myPlayers');
      var removeFilter = resetList.children('.playerList').get();
      $.each(removeFilter, function(idx, itm) {
        for (let i = itm.classList.length - 1; i >= 0; i--) {
          const className = itm.classList[i];
          if (className.startsWith('order')) {
            itm.classList.remove(className);
          }
        }
      });
    });
  });
</script>
